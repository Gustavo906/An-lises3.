<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROSTATS APEX | Titan v51.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@500;700;800&display=swap');
        
        :root { 
            --bg: #030305; --card: #0a0a0c; --border: #1a1a1e; 
            --accent: #3b82f6; --live: #ef4444; --away: #f59e0b; 
            --win: #10b981; --loss: #ef4444; --draw: #71717a; 
        }
        
        body { background: var(--bg); color: #e4e4e7; font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }

        /* Grid Principal */
        .game-card { 
            background: var(--card); border: 1px solid var(--border); border-radius: 16px; 
            transition: all 0.2s ease; cursor: pointer;
        }
        .game-card:hover { border-color: var(--accent); background: #0c0c11; transform: translateY(-2px); }

        .min-badge { 
            font-family: 'JetBrains Mono'; font-size: 10px; background: rgba(59, 130, 246, 0.1); 
            color: var(--accent); padding: 3px 8px; border-radius: 5px; font-weight: 800;
        }

        /* Modal Ultra Clarity */
        #modal { display: none; backdrop-filter: blur(30px); z-index: 10000; }
        #modal.active { display: flex; }
        .modal-body { 
            background: #050507; border: 1px solid #27272a; width: 95%; max-width: 950px; 
            border-radius: 28px; max-height: 94vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* Histórico Reestruturado v51 */
        .hist-container { display: flex; flex-direction: column; gap: 4px; }
        .hist-row { 
            display: flex; align-items: center; background: #0e0e11; 
            padding: 8px 12px; border-radius: 8px; border: 1px solid #161618;
            height: 34px; gap: 12px;
        }
        .res-pill { 
            width: 18px; height: 18px; border-radius: 4px; flex-shrink: 0;
            font-size: 9px; font-weight: 900; display: flex; align-items: center; justify-content: center;
            font-family: 'JetBrains Mono';
        }
        .bg-v { background: var(--win); color: #000; }
        .bg-d { background: var(--loss); color: #fff; }
        .bg-e { background: var(--draw); color: #fff; }

        .hist-score { font-family: 'JetBrains Mono'; font-size: 10px; font-weight: 700; color: #fff; width: 35px; flex-shrink: 0; }
        .hist-opp { font-size: 10px; font-weight: 500; color: #71717a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }

        /* Barras de Probabilidade */
        .bar-bg { height: 5px; background: #161618; border-radius: 10px; overflow: hidden; margin-top: 6px; }
        .bar-fill { height: 100%; width: 0%; transition: width 1s ease-in-out; }

        .live-pulse { width: 8px; height: 8px; background: var(--live); border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <nav class="h-16 border-b border-white/5 bg-black/90 sticky top-0 backdrop-blur-md z-[100] px-6 flex items-center justify-between">
        <div class="flex flex-col">
            <span class="text-white font-black italic text-base uppercase tracking-tighter">Titan <span class="text-blue-500 text-xs">v51.0 Clarity</span></span>
        </div>
        <select id="leagueSelect" onchange="initApp()" class="bg-zinc-900 border border-zinc-800 text-[10px] font-bold px-4 py-2 rounded-xl text-white outline-none">
            <option value="CL">CHAMPIONS LEAGUE</option>
            <option value="PL">PREMIER LEAGUE</option>
            <option value="BSA">BRASILEIRÃO A</option>
            <option value="PD">LA LIGA</option>
            <option value="SA">SERIE A</option>
        </select>
    </nav>

    <main class="p-4 md:p-8 max-w-7xl mx-auto">
        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>

    <!-- MODAL -->
    <div id="modal" class="fixed inset-0 p-3 md:p-4 items-center justify-center bg-black/95">
        <div class="modal-body shadow-2xl">
            <!-- HEADER -->
            <div class="p-4 border-b border-white/5 flex justify-between items-center bg-zinc-900/10">
                <div class="flex items-center gap-2">
                    <div class="live-pulse"></div>
                    <span class="text-[9px] font-black text-zinc-400 uppercase tracking-widest">Predictive Neural Engine</span>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center bg-zinc-900 rounded-lg text-zinc-400 hover:text-white transition-all">&times;</button>
            </div>

            <div class="p-6 md:p-8 overflow-y-auto flex-1">
                <!-- BANNER CENTRAL -->
                <div class="bg-gradient-to-b from-zinc-900/40 to-black/20 border border-white/5 rounded-[24px] p-6 md:p-10 mb-8">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex-1 text-center">
                            <img id="mLogoH" class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-3 object-contain" onerror="this.src='https://via.placeholder.com/60?text=Logo'">
                            <div id="mNameH" class="text-[10px] font-bold text-white uppercase tracking-wider truncate">--</div>
                        </div>
                        <div class="flex-1 text-center">
                            <div class="text-[8px] font-black text-blue-500 uppercase mb-2 tracking-[2px]">Estimativa Titan</div>
                            <div id="mScore" class="text-5xl md:text-7xl font-black italic mono text-white leading-none">0-0</div>
                            <div class="flex items-center justify-center gap-2 mt-4">
                                <span id="mMin" class="min-badge">--</span>
                                <span id="mCurrentScore" class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest">Real: 0-0</span>
                            </div>
                        </div>
                        <div class="flex-1 text-center">
                            <img id="mLogoA" class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-3 object-contain" onerror="this.src='https://via.placeholder.com/60?text=Logo'">
                            <div id="mNameA" class="text-[10px] font-bold text-amber-500 uppercase tracking-wider truncate">--</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <!-- PROBABILIDADES -->
                    <div class="lg:col-span-4 space-y-6">
                        <div class="bg-[#0c0c0e] border border-white/5 p-6 rounded-2xl">
                            <h4 class="text-[9px] font-black text-zinc-500 uppercase mb-6 tracking-widest">Probabilidades Finais</h4>
                            <div class="space-y-6">
                                <div>
                                    <div class="flex justify-between text-[10px] font-bold uppercase"><span>Mandante</span> <span id="mProbH">0%</span></div>
                                    <div class="bar-bg"><div id="mBarH" class="bar-fill bg-blue-600"></div></div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-[10px] font-bold uppercase"><span>Empate</span> <span id="mProbD">0%</span></div>
                                    <div class="bar-bg"><div id="mBarD" class="bar-fill bg-zinc-600"></div></div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-[10px] font-bold uppercase text-amber-500"><span>Visitante</span> <span id="mProbA">0%</span></div>
                                    <div class="bar-bg"><div id="mBarA" class="bar-fill bg-amber-500"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- HISTÓRICO ULTRA CLARITY -->
                    <div class="lg:col-span-8 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-[9px] font-black text-blue-500 uppercase mb-4 tracking-widest">Forma: Mandante</h4>
                                <div id="mHistoryH" class="hist-container"></div>
                            </div>
                            <div>
                                <h4 class="text-[9px] font-black text-amber-500 uppercase mb-4 tracking-widest">Forma: Visitante</h4>
                                <div id="mHistoryA" class="hist-container"></div>
                            </div>
                        </div>
                        <div class="bg-zinc-900/40 p-5 rounded-2xl border border-white/5 border-l-4 border-blue-500">
                            <p id="mTacticalReport" class="text-xs text-zinc-400 leading-relaxed font-medium italic">Aguardando telemetria de campo...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '8e3c0eba984c46a090a5c53c37835285';
        const PROXY = "https://corsproxy.io/?";
        let engine = { tableMaster: [], matches: [], realHistory: {} };

        function factorial(n) { return n <= 1 ? 1 : n * factorial(n - 1); }
        function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }
        function cleanName(n) { return n ? n.replace(/\s+FC$|\s+CF$|\s+United$|\s+City$|\s+Wanderers$|\s+Hotspur$|\s+Athletic$|\s+Sporting$|\s+Club$/gi, '') : "Time"; }

        function getMatchMinute(startTime) {
            const diff = Math.floor((new Date() - new Date(startTime)) / 60000);
            return diff < 0 ? 0 : (diff > 90 ? 90 : (diff > 45 && diff < 60 ? 45 : (diff >= 60 ? diff - 15 : diff)));
        }

        async function studyMatches(league) {
            try {
                const res = await fetch(`${PROXY}https://api.football-data.org/v4/competitions/${league}/matches?status=FINISHED`, { headers: {'X-Auth-Token': API_KEY}});
                const data = await res.json();
                engine.realHistory = {};
                if(data.matches) {
                    data.matches.slice(-100).forEach(m => {
                        const hId = m.homeTeam.id, aId = m.awayTeam.id;
                        const hS = m.score.fullTime.home, aS = m.score.fullTime.away;
                        const hR = hS > aS ? 'v' : (hS === aS ? 'e' : 'd');
                        const aR = aS > hS ? 'v' : (aS === hS ? 'e' : 'd');
                        if(!engine.realHistory[hId]) engine.realHistory[hId] = [];
                        if(!engine.realHistory[aId]) engine.realHistory[aId] = [];
                        engine.realHistory[hId].push({ score: `${hS}-${aS}`, res: hR, opp: cleanName(m.awayTeam.name) });
                        engine.realHistory[aId].push({ score: `${aS}-${hS}`, res: aR, opp: cleanName(m.homeTeam.name) });
                    });
                }
            } catch (e) { console.error("History Error"); }
        }

        async function initApp() {
            const league = document.getElementById('leagueSelect').value;
            const grid = document.getElementById('grid');
            try {
                await studyMatches(league);
                const [resS, resM] = await Promise.all([
                    fetch(`${PROXY}https://api.football-data.org/v4/competitions/${league}/standings`, { headers: {'X-Auth-Token': API_KEY}}),
                    fetch(`${PROXY}https://api.football-data.org/v4/competitions/${league}/matches`, { headers: {'X-Auth-Token': API_KEY}})
                ]);
                const sD = await resS.json();
                const mD = await resM.json();

                engine.tableMaster = [];
                if (sD.standings) sD.standings.forEach(g => { if (g.table) engine.tableMaster.push(...g.table); });

                const today = new Date().toISOString().split('T')[0];
                const active = mD.matches.filter(m => m.homeTeam && m.awayTeam && (m.utcDate.includes(today) || m.status === 'IN_PLAY' || m.status === 'PAUSED'));
                engine.matches = active;

                grid.innerHTML = active.map(m => {
                    const isLive = m.status === 'IN_PLAY' || m.status === 'PAUSED';
                    return `
                    <div onclick="openAnalysis(${m.id})" class="game-card p-5">
                        <div class="flex justify-between items-center mb-5">
                            <span class="text-[9px] font-black ${isLive ? 'text-red-500' : 'text-zinc-600'} uppercase tracking-widest">${isLive ? '• LIVE' : 'Agendado'}</span>
                            <span class="min-badge">${isLive ? getMatchMinute(m.utcDate) + "'" : new Date(m.utcDate).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2 text-[11px] font-bold text-white uppercase"><img src="${m.homeTeam.crest}" class="w-4 h-4 object-contain" onerror="this.src='https://via.placeholder.com/20'"> ${cleanName(m.homeTeam.name)}</div>
                                <span class="mono font-black text-sm text-white">${m.score.fullTime.home ?? 0}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2 text-[11px] font-bold text-white uppercase"><img src="${m.awayTeam.crest}" class="w-4 h-4 object-contain" onerror="this.src='https://via.placeholder.com/20'"> ${cleanName(m.awayTeam.name)}</div>
                                <span class="mono font-black text-sm text-white">${m.score.fullTime.away ?? 0}</span>
                            </div>
                        </div>
                    </div>`;
                }).join('') || `<div class="col-span-full py-24 text-center text-zinc-700 uppercase font-black text-[10px] tracking-[4px]">Sem eventos agendados</div>`;
            } catch (e) { console.error("Init Error"); }
        }

        function openAnalysis(mId) {
            const m = engine.matches.find(x => x.id === mId);
            if(!m) return;

            let hT = engine.tableMaster.find(t => t.team.id === m.homeTeam.id) || { goalsFor: 1.4, goalsAgainst: 1.4, playedGames: 1 };
            let aT = engine.tableMaster.find(t => t.team.id === m.awayTeam.id) || { goalsFor: 1.4, goalsAgainst: 1.4, playedGames: 1 };

            const isLive = m.status === 'IN_PLAY' || m.status === 'PAUSED';
            const curH = m.score.fullTime.home ?? 0;
            const curA = m.score.fullTime.away ?? 0;
            const min = isLive ? getMatchMinute(m.utcDate) : 0;
            const rem = Math.max(0, 95 - min) / 90;

            const lambdaH = (hT.goalsFor/hT.playedGames) * (aT.goalsAgainst/aT.playedGames) * rem;
            const lambdaA = (aT.goalsFor/aT.playedGames) * (hT.goalsAgainst/hT.playedGames) * rem;

            let pH=0, pD=0, pA=0, maxP=-1, bestS="0-0";
            for(let i=0; i<6; i++) {
                for(let j=0; j<6; j++) {
                    const prob = poisson(i, lambdaH) * poisson(j, lambdaA);
                    const fH = curH + i; const fA = curA + j;
                    if(fH > fA) pH += prob; else if(fH === fA) pD += prob; else pA += prob;
                    if(prob > maxP) { maxP = prob; bestS = `${fH} - ${fA}`; }
                }
            }

            const total = Math.max(0.0001, pH + pD + pA);
            const renderHist = (id) => (engine.realHistory[id] || []).slice(-5).reverse().map(j => `
                <div class="hist-row">
                    <div class="res-pill bg-${j.res}">${j.res.toUpperCase()}</div>
                    <div class="hist-score">${j.score}</div>
                    <div class="hist-opp">vs ${j.opp}</div>
                </div>`).join('');

            document.getElementById('modal').classList.add('active');
            document.getElementById('mHistoryH').innerHTML = renderHist(m.homeTeam.id);
            document.getElementById('mHistoryA').innerHTML = renderHist(m.awayTeam.id);
            document.getElementById('mScore').innerText = bestS;
            document.getElementById('mCurrentScore').innerText = `Real: ${curH}-${curA}`;
            document.getElementById('mMin').innerText = isLive ? min + "'" : "PRÉ-JOGO";
            document.getElementById('mNameH').innerText = cleanName(m.homeTeam.name);
            document.getElementById('mNameA').innerText = cleanName(m.awayTeam.name);
            document.getElementById('mLogoH').src = m.homeTeam.crest;
            document.getElementById('mLogoA').src = m.awayTeam.crest;

            const upd = (id, bar, val) => {
                const perc = ((val/total) * 100).toFixed(1);
                document.getElementById(id).innerText = perc + "%";
                setTimeout(() => document.getElementById(bar).style.width = perc + "%", 100);
            };
            upd('mProbH', 'mBarH', pH); upd('mProbD', 'mBarD', pD); upd('mProbA', 'mBarA', pA);
            
            document.getElementById('mTacticalReport').innerText = `O modelo preditivo Titan indica que o placar mais provável até o encerramento é ${bestS}. A forma recente do visitante apresenta um índice de periculosidade residual de ${(lambdaA).toFixed(2)} gols esperados.`;
        }

        function closeModal() { 
            document.getElementById('modal').classList.remove('active'); 
            ['mBarH', 'mBarD', 'mBarA'].forEach(b => document.getElementById(b).style.width = '0%');
        }
        
        window.onload = initApp;
        setInterval(initApp, 60000);
    </script>
</body>
</html>
